#include <SoftwareSerial.h>

/* ==================== 상수 설정 ==================== */
//입출력
#define BT_RXD 4
#define BT_TXD 5
short const trig = 2;
short const echo = 3;
short const rainingPin = A1;

//전원
short const lvSensor = 8;
short const rainSensor = 9;

//반복 속도
short const loopDelay = 500;


/* ==================== 변수 선언 ==================== */
bool isWater = false;
long initialDistance;
SoftwareSerial ESP_wifi(BT_RXD, BT_TXD);


/* ==================== 초기화 함수 ==================== */
void setup(){
  //초기화
  Serial.begin(9600);
  pinMode(trig, OUTPUT);
  pinMode(echo, INPUT);

  //전원 초기화
  pinMode(lvSensor, OUTPUT);
  pinMode(rainSensor, OUTPUT);

  //초기 거리 측정
  digitalWrite(lvSensor, HIGH);
  do{
    delay(loopDelay);
    initialDistance = getDistance(true);
  }while(initialDistance < 1);
  digitalWrite(lvSensor, LOW);

  //전원 공급
  digitalWrite(rainSensor, HIGH);

  //초기 거리 출력
  Serial.print("Initial Distance: ");
  Serial.println(initialDistance);

  //와이파이 모듈 초기화
  ESP_wifi.begin(9600);
  ESP_wifi.setTimeout(5000);
}


/* ==================== 반복 함수 ==================== */
void loop(){
  long distance = 0;

  //반복 속도 조절
  delay(loopDelay);

  //수위 및 물 감지
  if(isWater){
    distance = getDistance(false);
    Serial.print("\nWater detected : ");
    Serial.print(isWater);
    wifi();
  }
  else{
    isWater = waterDetect();
    Serial.println("not watwer");
    return;
  }

  //정보 전송
  sendData(distance);
}


/* ==================== 정보 전송 ==================== */
void sendData(long level){
  Serial.print("\ndistance : ");
  Serial.print(level);
  Serial.print("cm");
}


/* ==================== 수위 측정 ==================== */
long getDistance(bool initial){
  unsigned long duration;

  //초음파 발생
  digitalWrite(trig, HIGH);
  delay(500);
  digitalWrite(trig, LOW);

  //시간을 duration에 저장
  duration = pulseIn(echo, HIGH);

  //반환
  if(initial){
    return (long)(duration * 0.017);
  }
  else{
    return (long)(initialDistance - duration * 0.017);
  }
}


/* ==================== 물 감지 ==================== */
bool waterDetect(){
  if (analogRead(rainingPin) < 500){
    digitalWrite(rainSensor, LOW);
    digitalWrite(lvSensor, HIGH);
    return true;
  }
  else{
    return false;
  }
}


/* ==================== 와이파이 ==================== */
void wifi(){
  if (Serial.available()){
    ESP_wifi.write(Serial.read());
  }
  if (ESP_wifi.available()){
    Serial.write(ESP_wifi.read());
  }
}